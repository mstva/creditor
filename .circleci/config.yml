# This configuration has been automatically generated by the CircleCI Config SDK.
# For more information, see https://github.com/CircleCI-Public/circleci-config-sdk-ts
# SDK Version: 0.0.0-development

version: 2.1
setup: false
jobs:
  deploy_development_environment:
    machine:
      image: ubuntu-2204:2022.10.1
    resource_class: large
    steps:
      - checkout
      - run:
          name: Set the environment variables
          command: python3 crewtech_scripts/set_env_vars.py --env=development --token=$CIRCLE_TOKEN --owner=$OWNER_ID
      - run:
          name: Push the code
          command: rsync -r --progress --stats crewtech_api crewtech_scripts/run_app.py root@$SERVER_IP:/root/crewtech
      - run:
          name: Run the script
          command: ssh root@$SERVER_IP 'python3 crewtech/run_app.py --e=development'
  deploy_staging_environment:
    machine:
      image: ubuntu-2204:2022.10.1
    resource_class: large
    steps:
      - checkout
      - run:
          name: Set the environment variables
          command: python3 crewtech_scripts/set_env_vars.py --env=staging --token=$CIRCLE_TOKEN --owner=$OWNER_ID
      - run:
          name: Push the code
          command: rsync -r --progress --stats crewtech_api crewtech_scripts/run_app.py root@$SERVER_IP:/root/crewtech
      - run:
          name: Run the script
          command: ssh root@$SERVER_IP 'python3 crewtech/run_app.py --e=staging'
  deploy_production_environment:
    machine:
      image: ubuntu-2204:2022.10.1
    resource_class: large
    steps:
      - checkout
      - run:
          name: Set the environment variables
          command: python3 crewtech_scripts/set_env_vars.py --env=production --token=$CIRCLE_TOKEN --owner=$OWNER_ID
      - run:
          name: Push the code
          command: rsync -r --progress --stats crewtech_api crewtech_scripts/run_app.py root@$SERVER_IP:/root/crewtech
      - run:
          name: Run the script
          command: ssh root@$SERVER_IP 'python3 crewtech/run_app.py --e=production'
workflows:
  deploy:
    jobs:
      - deploy_development_environment:
          context:
            - crewtech_common_context
            - crewtech_development_context
          filters:
            branches:
              only:
                - main
          requires: []
      - deploy_staging_environment:
          context:
            - crewtech_common_context
            - crewtech_staging_context
          filters:
            branches:
              only:
                - main
          requires:
            - deploy_development_environment
      - deploy_production_environment:
          context:
            - crewtech_common_context
            - crewtech_production_context
          filters:
            branches:
              only:
                - main
          requires:
            - deploy_staging_environment
